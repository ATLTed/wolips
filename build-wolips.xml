<?xml version="1.0"?>

<!-- ======================================================== -->
<!--                 WOLips Ant file.                         -->
<!-- ======================================================== -->
<project name="woproject-wolips" default="java" basedir=".">
	<property file="build.properties" />
    <property file="${user.home}/build.properties" />
    <property file="default.properties" />
    <property environment="env"/>
    <property name="output" value="output"/>
    <property name="next.root" value="${env.NEXT_ROOT}"/>
    
    <!-- ============================================= -->
    <!-- Derived Properties.                           -->
    <!-- ============================================= -->
    <property name="build" value="${output}/build"/>
    <property name="wolips-name" value="com.objectstyle.woproject.wolips-${project.version}"/>
    <property name="dist-wolips" value="${dist.base}/${wolips-name}"/>
    <!-- main distribution. -->
    <property name="dist" value="${dist.base}/${project.name}-${project.version}"/>

    <!-- ============================================= -->
    <!-- Define CLASSPATH settings.                    -->
    <!-- ============================================= -->
    <target name="defineClasspath">
        <condition property="next.root" value="/System">
            <and>
                <os family="mac" />
                <os family="unix" />
            </and>
        </condition>
        <path id="classpath">
            <fileset dir="${ant.home}/lib">
                <include name="ant.jar"/>
            </fileset>
            <fileset dir="lib">
                <include name="*.jar"/>
	            <include name="eclipse/**/*.jar"/>
            </fileset>
            <fileset dir="${next.root}/Library/Frameworks">
                <include name="JavaFoundation.framework/Resources/Java/*.jar"/>
            </fileset>
             <!-- Depends on WOProject core. -->
            <pathelement path="${build}/main"/>
        </path>
    </target>

    <target name="java" depends="prepare">
        <javac srcdir="src/wolips/java"
                destdir="${build}/wolips"
                deprecation="${compile.deprecation}"
                debug="${compile.debug}"
                optimize="${compile.optimize}">
            <classpath refid="classpath"/>
        </javac>
         
        <jar jarfile="${dist-wolips}/lib/${project.name}-wolips.jar">
            <fileset dir="${build}/wolips"/>
            <fileset dir="src/wolips/java">
          	    <include name="**/*.properties"/>
             </fileset>         
            <metainf dir="doc">
                <include name="LICENSE*"/>
            </metainf>
        </jar>
        
        <!-- Copy WOProject JAR's -->
        <copy todir="${dist-wolips}/lib">
             <fileset dir="${dist}/lib">
             	<exclude name="junit.jar"/>
             	<exclude name="ant.jar"/>
             	<exclude name="woproject-tests.jar"/>
             </fileset>
         </copy>
    </target>

    <target name="dist" depends="prepare,java,doc,api">
         <!-- Copy source code -->
         <copy todir="${dist-wolips}/src">
             <fileset dir="src/wolips/java"/>
         </copy>
         
         <copy todir="${dist-wolips}">
             <fileset dir="src/wolips">
             	<exclude name="**/java/**"/>
             	<exclude name="**/lib/**"/>
             	<exclude name="**/xdocs/**"/>
             	<exclude name="**/docs/**"/>
             	<exclude name=".project"/>
             	<exclude name=".classpath"/>
             </fileset>
         </copy>
         
	     <!-- make wolips dist -->
         <tar tarfile="${dist-wolips}.tar">
             <tarfileset dir="${dist-wolips}">
            </tarfileset>
         </tar>
         
         <gzip src="${dist-wolips}.tar"
              zipfile="${dist-wolips}.tar.gz"/>
         <delete file="${dist-wolips}.tar"/>
    </target>
         
         
         
    <!-- ============================================= -->
    <!-- Sets up build and distribution directories.   -->
    <!-- ============================================= -->
    <target name="prepare" depends="defineClasspath">
        <mkdir dir="${build}/wolips"/>
        <mkdir dir="${dist-wolips}/lib"/>
        <mkdir dir="${dist-wolips}/doc/api"/>
    </target>


    <!-- ============================================= -->
    <!-- Deletes temporary files.                      -->
    <!-- ============================================= -->
    <target name="clean">
        <delete dir="${build}/wolips"/>
        <delete dir="${dist-wolips}"/>
    </target>
    
    
    <!-- ============================================= -->
    <!-- Deploys WOLips web site files in a local      -->
    <!-- directory.                                    -->
    <!-- ============================================= -->
    <target name="deploy-web" depends="prepare,doc,api" if="deploy.web">
         <mkdir dir="${deploy.web}/woproject"/>

         <!-- copy all but HTML -->
         <copy todir="${deploy.web}/woproject">
             <fileset dir="${dist-wolips}/doc">
             	<exclude name="**/*.html"/>
             </fileset>
         </copy>

         <!-- do replacement in HTML files -->
         <copy todir="${deploy.web}/woproject" overwrite="true">
             <fileset dir="${dist-wolips}/doc">
             	<include name="**/*.html"/>
             </fileset>

             <filterset begintoken="!--" endtoken="--">
				<filter token="SFLOGO" value="${sf.logo}"/>
			 </filterset>
         </copy>
    </target>
    
    
    <!-- ========================================== -->
    <!-- Builds API documenatation.                 -->
    <!-- ========================================== -->
    <target name="api" depends="prepare">
        <copy todir="${dist-wolips}/doc">
            <fileset dir="doc">
                <include name="**/LICENSE*"/>
            </fileset>
        </copy>

        <javadoc   packagenames="org.objectstyle.wolips.*"
                   defaultexcludes="yes"
                   destdir="${dist-wolips}/doc/api"
                   author="true"
                   version="true"
                   use="true"
                   windowtitle="WOLips API">

        <classpath refid="classpath"/>
        <sourcepath>
            <pathelement path="src/wolips/java"/>
        </sourcepath>
        <doctitle><![CDATA[<h2>WOLips API Documentation</h2>]]></doctitle>
        <link href="http://developer.java.sun.com/developer/products/xml/docs/api/"/>
        </javadoc>
    </target>
    
    
    <target name="doc" depends="prepare">
        <!-- copy all licenses inclusing ours -->
        <copy todir="${dist-wolips}/doc">
            <fileset dir="doc">
               <include name="LICENSE*"/>
            </fileset>
        </copy>

        <taskdef name="anakia" classname="org.apache.velocity.anakia.AnakiaTask">
            <classpath refid="classpath"/>
        </taskdef>

        <!-- Build site in WOProject site directory -->
        <anakia basedir="src/wolips/xdocs" destdir="${dist}/doc"
             extension=".html" style="woproject.vsl"
             projectFile="../../../xdocs/stylesheets/project.xml"
             excludes="**/stylesheets/**"
             includes="**/*.xml"
             lastModifiedCheck="true"
             templatePath="xdocs/stylesheets">
        </anakia>
        
       <!-- Build site in Plugin docs directory -->
        <anakia basedir="src/wolips/xdocs/wolips" destdir="${dist-wolips}/doc"
             extension=".html" style="wolips.vsl"
             excludes="**/stylesheets/**"
             includes="**/*.xml"
             lastModifiedCheck="true"
             templatePath="src/wolips/xdocs/stylesheets">
        </anakia>

        <!-- copy images -->
        <copy todir="${dist}/doc/images/wolips" filtering="no">
            <fileset dir="src/wolips/xdocs/images">
                <include name="**/*.gif"/>
                <include name="**/*.jpeg"/>
                <include name="**/*.jpg"/>
                <include name="**/*.css"/>
            </fileset>
        </copy>
        <copy todir="${dist-wolips}/doc/images/wolips" filtering="no">
            <fileset dir="src/wolips/xdocs/images">
                <include name="**/*.gif"/>
                <include name="**/*.jpeg"/>
                <include name="**/*.jpg"/>
                <include name="**/*.css"/>
            </fileset>
        </copy>
    </target>
</project>
